{% extends "base.html" %}

{% block title %}Book Issue - Library Management System{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="admin-wrapper">
    <header class="admin-header">
        <div class="container">
            <nav class="admin-nav">
                <a href="{{ url_for('librarian_dashboard') }}" class="admin-logo">
                    <div class="admin-logo-icon">LMS</div>
                    Library Management System
                </a>
                
                <div class="admin-user">
                    <div class="admin-user-info">
                        <div class="admin-user-name">{{ user_name }}</div>
                        <div class="admin-user-role">Librarian</div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="admin-logout-btn">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <div class="container">
            <div class="admin-content">
                <div class="breadcrumb">
                    <a href="{{ url_for('librarian_dashboard') }}">Dashboard</a> > Book Issue
                </div>

                <div class="content-section">
                    <h1>üì§ Book Issue</h1>
                    <p>Issue books to students</p>
                    <a href="{{ url_for('librarian_dashboard') }}" class="btn btn-outline" style="margin-bottom: 1.5rem;">
                        ‚Üê Back to Dashboard
                    </a>
                </div>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST" id="issue-form">
                    <section class="admin-quick-nav">
                        <h2 class="admin-quick-nav-title">Select Book</h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>ISBN</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for book in books %}
                                    <tr>
                                        <td>
                                            <input type="radio" name="book_id" value="{{ book.book_id }}" 
                                                   class="book-radio" onchange="updateBookSelection()">
                                        </td>
                                        <td>{{ book.title }}</td>
                                        <td>{{ book.author }}</td>
                                        <td>{{ book.isbn }}</td>
                                        <td><span class="status-badge available">Available</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="selection-info">
                            <span id="book-selection">No book selected</span>
                        </div>
                    </section>

                    <section class="admin-quick-nav">
                        <h2 class="admin-quick-nav-title">Select Student</h2>
                        <div class="form-section">
                            <div class="form-group">
                                <label class="form-label">Student</label>
                                <select name="user_id" class="form-control" required onchange="updateStudentSelection()">
                                    <option value="">Choose a student</option>
                                    {% for student in students %}
                                    <option value="{{ student.UserID }}" data-borrowed-count="{{ student.borrowed_count or 0 }}">
                                        {{ student.student_name }} 
                                        {% if student.borrowed_count and student.borrowed_count > 0 %}
                                        ({{ student.borrowed_count }}/3 books borrowed)
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary" id="issue-btn" disabled>
                                    üì§ Issue Book
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearSelection()">
                                    Clear Selection
                                </button>
                            </div>
                        </div>
                    </section>
                </form>

                <section class="admin-quick-nav">
                    <h2 class="admin-quick-nav-title">All Issued Books - Book to Student Assignments</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>üìö Issued Book</th>
                                    <th>üë§ Issued To (Student)</th>
                                    <th>üìÖ Issue Date</th>
                                    <th>‚è∞ Due Date</th>
                                    <th>üìß Contact</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if issued_books %}
                                    {% for issue in issued_books %}
                                    <tr>
                                        <td>
                                            <div style="font-weight: bold; color: #2c5aa0;">{{ issue.title }}</div>
                                            <div style="font-size: 0.9em; color: #666;">by {{ issue.author }}</div>
                                            <div style="font-size: 0.8em; color: #888;">ID: {{ issue.book_id }} | ISBN: {{ issue.isbn }}</div>
                                        </td>
                                        <td>
                                            <div style="font-weight: bold; color: #d63384;">{{ issue.student_name }}</div>
                                            <div style="font-size: 0.9em; color: #666;">Student ID: {{ issue.UserID }}</div>
                                        </td>
                                        <td>{{ issue.issue_date }}</td>
                                        <td>{{ issue.due_date }}</td>
                                        <td>
                                            <a href="mailto:{{ issue.student_email }}" style="color: #0d6efd; text-decoration: none;">
                                                {{ issue.student_email }}
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No books have been issued yet</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
</div>

<style>
.selection-info {
    margin-top: 1rem;
    padding: 0.5rem;
    background-color: var(--background-secondary);
    border-radius: var(--radius-md);
    font-weight: 500;
    color: var(--text-primary);
}

.book-radio {
    transform: scale(1.2);
    margin: 0;
}

#issue-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
}

.status-badge.available {
    background-color: #d4edda;
    color: #155724;
}

.status-badge.issued {
    background-color: #fff3cd;
    color: #856404;
}

.text-center {
    text-align: center;
    font-style: italic;
    color: var(--text-secondary);
}
</style>

<script>
function updateBookSelection() {
    const selectedBook = document.querySelector('input[name="book_id"]:checked');
    const bookSelection = document.getElementById('book-selection');
    
    if (selectedBook) {
        const row = selectedBook.closest('tr');
        const title = row.children[1].textContent;
        const author = row.children[2].textContent;
        bookSelection.textContent = `Selected: ${title} by ${author}`;
    } else {
        bookSelection.textContent = 'No book selected';
    }
    
    updateIssueButton();
}

function updateStudentSelection() {
    const studentSelect = document.querySelector('select[name="user_id"]');
    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const borrowedCount = parseInt(selectedOption.getAttribute('data-borrowed-count') || '0');
        
        if (borrowedCount >= 3) {
            alert('Warning: This student has already borrowed 3 books and cannot take another one.');
            studentSelect.value = '';
        }
    }
    
    updateIssueButton();
}

function updateIssueButton() {
    const selectedBook = document.querySelector('input[name="book_id"]:checked');
    const selectedStudent = document.querySelector('select[name="user_id"]').value;
    const issueBtn = document.getElementById('issue-btn');
    
    issueBtn.disabled = !selectedBook || !selectedStudent;
}

function clearSelection() {
    // Clear book selection
    const bookRadios = document.querySelectorAll('.book-radio');
    bookRadios.forEach(radio => {
        radio.checked = false;
    });
    
    // Clear student selection
    document.querySelector('select[name="user_id"]').value = '';
    
    // Update displays
    document.getElementById('book-selection').textContent = 'No book selected';
    document.getElementById('issue-btn').disabled = true;
}
</script>
{% endblock %}
