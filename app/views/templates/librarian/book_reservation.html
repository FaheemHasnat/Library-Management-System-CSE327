{% extends "base.html" %}

{% block title %}Book Reservation - Library Management System{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="admin-wrapper">
    <header class="admin-header">
        <div class="container">
            <nav class="admin-nav">
                <a href="{{ url_for('librarian_dashboard') }}" class="admin-logo">
                    <div class="admin-logo-icon">LMS</div>
                    Library Management System
                </a>
                
                <div class="admin-user">
                    <div class="admin-user-info">
                        <div class="admin-user-name">{{ user_name }}</div>
                        <div class="admin-user-role">Librarian</div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="admin-logout-btn">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <div class="container">
            <div class="admin-content">
                <section class="admin-welcome">
                    <h1 class="admin-welcome-title">üìã Book Reservation</h1>
                    <p class="admin-welcome-subtitle">Select books and assign them to students</p>
                    <a href="{{ url_for('librarian_dashboard') }}" class="admin-welcome-badge">‚Üê Back to Dashboard</a>
                </section>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'error' if category == 'error' else category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <section class="admin-table-section">
                    <div class="table-stats">
                        <div class="table-stat-item">
                            <div class="table-stat-icon">üìñ</div>
                            <div>
                                <div class="table-stat-value">{{ books|length }}</div>
                                <div class="table-stat-label">Available Books</div>
                            </div>
                        </div>
                        <div class="table-stat-item">
                            <div class="table-stat-icon">üë•</div>
                            <div>
                                <div class="table-stat-value">{{ students|length }}</div>
                                <div class="table-stat-label">Students</div>
                            </div>
                        </div>
                        <div class="table-stat-item">
                            <div class="table-stat-icon">üìã</div>
                            <div>
                                <div class="table-stat-value">{{ reservations|length }}</div>
                                <div class="table-stat-label">Active Reservations</div>
                            </div>
                        </div>
                        <div class="table-stat-item">
                            <div class="table-stat-icon">‚ö†Ô∏è</div>
                            <div>
                                <div class="table-stat-value">3</div>
                                <div class="table-stat-label">Max Per Student</div>
                            </div>
                        </div>
                        <div class="table-stat-item">
                            <div class="table-stat-icon">üìä</div>
                            <div>
                                <div class="table-stat-value" id="selectedCount">0</div>
                                <div class="table-stat-label">Selected</div>
                            </div>
                        </div>
                    </div>

                    <form method="POST" id="reservationForm">
                        <div class="table-search-section">
                            <select class="table-search-input" name="student_id" required>
                                <option value="">Select Student</option>
                                {% for student in students %}
                                <option value="{{ student.user_id }}">{{ student.full_name }} ({{ student.email }})</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="admin-btn-primary">Create Reservations</button>
                            <button type="button" class="admin-btn-secondary" onclick="clearSelections()">Clear All</button>
                        </div>

                        <h2 class="admin-table-title">
                            üìö Select Books for Reservation
                        </h2>
                        
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>‚úÖ Select</th>
                                        <th>üìñ Book Title</th>
                                        <th>‚úçÔ∏è Author</th>
                                        <th>üìö Subject</th>
                                        <th>üî¢ ISBN</th>
                                    </tr>
                                </thead>
                                <tbody id="bookTableBody">
                                    {% for book in books %}
                                    {% if book.status == 'Available' %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="selected_books" value="{{ book.book_id }}" onchange="updateSelectionCount()">
                                        </td>
                                        <td>{{ book.title }}</td>
                                        <td>{{ book.author }}</td>
                                        <td>{{ book.subject }}</td>
                                        <td>{{ book.isbn }}</td>
                                    </tr>
                                    {% endif %}
                                    {% else %}
                                    <tr>
                                        <td colspan="5">No available books found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                </section>

                {% if reservations %}
                <section class="admin-table-section">
                    <h2 class="admin-table-title">
                        üìã Recent Reservations
                    </h2>
                    
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>üìñ Book Title</th>
                                    <th>üë§ Student</th>
                                    <th>üìÖ Reservation Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in reservations %}
                                <tr>
                                    <td>{{ reservation.title }}</td>
                                    <td>{{ reservation.full_name }}</td>
                                    <td>{{ reservation.reservation_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<style>
.alert {
    padding: 12px 20px;
    margin-bottom: 20px;
    border-radius: 4px;
    border: 1px solid transparent;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-error {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

input[type="checkbox"] {
    transform: scale(1.2);
    margin: 0 auto;
    display: block;
}
</style>

<script>
function updateSelectionCount() {
    const checkboxes = document.querySelectorAll('input[name="selected_books"]:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;
    
    if (count > 3) {
        alert('You can select maximum 3 books at a time');
        checkboxes[checkboxes.length - 1].checked = false;
        document.getElementById('selectedCount').textContent = '3';
    }
}

function clearSelections() {
    const checkboxes = document.querySelectorAll('input[name="selected_books"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectedCount').textContent = '0';
    document.querySelector('select[name="student_id"]').value = '';
}

document.getElementById('reservationForm').addEventListener('submit', function(e) {
    const checkboxes = document.querySelectorAll('input[name="selected_books"]:checked');
    const studentSelect = document.querySelector('select[name="student_id"]');
    
    if (checkboxes.length === 0) {
        e.preventDefault();
        alert('Please select at least one book');
        return;
    }
    
    if (!studentSelect.value) {
        e.preventDefault();
        alert('Please select a student');
        return;
    }
});
</script>
{% endblock %}
