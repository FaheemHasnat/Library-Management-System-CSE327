{% extends "base.html" %}

{% block title %}Book Reservation - Student Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="admin-wrapper">
    <header class="admin-header">
        <div class="container">
            <nav class="admin-nav">
                <a href="{{ url_for('student_dashboard') }}" class="admin-logo">
                    <div class="admin-logo-icon">LMS</div>
                    Library Management System
                </a>
                
                <div class="admin-user">
                    <div class="admin-user-info">
                        <div class="admin-user-name">{{ user_name }}</div>
                        <div class="admin-user-role">Student</div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="admin-logout-btn">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="admin-main">
        <div class="container">
            <div class="admin-content">
                <section class="admin-welcome">
                    <h1 class="admin-welcome-title">üìã Book Reservation</h1>
                    <p class="admin-welcome-subtitle">Reserve available books for your studies (Maximum 3 books total)</p>
                    <a href="{{ url_for('student_dashboard') }}" class="admin-welcome-badge">‚Üê Back to Dashboard</a>
                </section>

                <div class="reservation-status">
                    <div class="status-card">
                        <h3>Your Reservation Status</h3>
                        <div class="status-info">
                            <span class="current-count">{{ user_reservations|length }}</span> / 3 books reserved
                        </div>
                        <div class="remaining-info">
                            {% if remaining_slots > 0 %}
                                You can reserve {{ remaining_slots }} more book(s)
                            {% else %}
                                You have reached the maximum reservation limit
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="admin-alerts">
                            {% for category, message in messages %}
                                <div class="admin-alert admin-alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('student_book_reservation') }}" id="reservation-form">
                    <section class="admin-table-section">
                        <div class="table-search-section">
                            <div class="selection-info">
                                <span id="selection-count">0</span> of {{ remaining_slots }} available slots selected
                            </div>
                            {% if remaining_slots > 0 %}
                            <div class="action-buttons">
                                <button type="submit" class="admin-btn-primary" id="confirm-btn" disabled>
                                    Reserve Selected Books
                                </button>
                                <button type="button" class="admin-btn-secondary" onclick="clearSelection()">
                                    Clear Selection
                                </button>
                            </div>
                            {% else %}
                            <div class="no-slots-message">
                                <p>You have reached the maximum reservation limit of 3 books.</p>
                            </div>
                            {% endif %}
                        </div>

                        <h2 class="admin-table-title">
                            üìö Available Books for Reservation
                        </h2>
                        
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>üìñ Book Title</th>
                                        <th>‚úçÔ∏è Author</th>
                                        <th>üìö Subject</th>
                                        <th>üî¢ ISBN</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if remaining_slots > 0 %}
                                        {% for book in books %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" name="selected_books" value="{{ book.book_id }}" 
                                                       class="book-checkbox" onchange="updateSelection()">
                                            </td>
                                            <td>{{ book.title }}</td>
                                            <td>{{ book.author }}</td>
                                            <td>{{ book.subject }}</td>
                                            <td>{{ book.isbn }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="no-books-message">
                                                No more reservations allowed. You have reached the maximum limit.
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </form>

                {% if user_reservations %}
                <section class="admin-table-section">
                    <h2 class="admin-table-title">
                        üìã My Current Reservations
                    </h2>
                    
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>üìñ Book Title</th>
                                    <th>‚úçÔ∏è Author</th>
                                    <th>üìö Subject</th>
                                    <th>üìÖ Reserved Date</th>
                                    <th>üè∑Ô∏è Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in user_reservations %}
                                <tr>
                                    <td>{{ reservation.title }}</td>
                                    <td>{{ reservation.author }}</td>
                                    <td>{{ reservation.subject }}</td>
                                    <td>{{ reservation.reservation_date }}</td>
                                    <td>
                                        <span class="status-badge available">
                                            {{ reservation.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<style>
.selection-info {
    margin-bottom: 1rem;
    padding: var(--spacing-sm);
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    color: var(--text-white);
    border-radius: var(--radius-md);
    font-weight: 600;
    text-align: center;
}

.action-buttons {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
    margin-bottom: var(--spacing-md);
}

.book-checkbox {
    transform: scale(1.2);
    margin: 0;
    cursor: pointer;
}

.book-checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#confirm-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.admin-alerts {
    margin-bottom: var(--spacing-md);
}

.admin-alert {
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-xs);
    font-weight: 500;
}

.admin-alert-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: var(--text-white);
}

.admin-alert-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: var(--text-white);
}

.admin-alert-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: var(--text-white);
}

.reservation-status {
    margin-bottom: var(--spacing-md);
}

.status-card {
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    color: var(--text-white);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    text-align: center;
}

.status-card h3 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-lg);
}

.status-info {
    font-size: var(--font-size-xl);
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
}

.current-count {
    font-size: 2rem;
    color: var(--text-white);
}

.remaining-info {
    font-size: var(--font-size-sm);
    opacity: 0.9;
}

.no-slots-message {
    text-align: center;
    padding: var(--spacing-md);
    background: var(--background-secondary);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
}

.no-books-message {
    text-align: center;
    padding: var(--spacing-lg);
    color: var(--text-secondary);
    font-style: italic;
}
</style>

<script>
const maxReservations = {{ remaining_slots }};

function updateSelection() {
    const checkboxes = document.querySelectorAll('.book-checkbox');
    const selectedCount = document.querySelectorAll('.book-checkbox:checked').length;
    const countDisplay = document.getElementById('selection-count');
    const confirmBtn = document.getElementById('confirm-btn');
    
    countDisplay.textContent = selectedCount;
    
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked && selectedCount >= maxReservations) {
            checkbox.disabled = true;
        } else {
            checkbox.disabled = false;
        }
    });
    
    if (confirmBtn) {
        confirmBtn.disabled = selectedCount === 0;
    }
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.book-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.disabled = false;
    });
    
    document.getElementById('selection-count').textContent = '0';
    const confirmBtn = document.getElementById('confirm-btn');
    if (confirmBtn) {
        confirmBtn.disabled = true;
    }
}
</script>

{% endblock %}
